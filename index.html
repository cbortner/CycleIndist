<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Skeletal Path Model</title>

  <!-- Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css" />

  <style>
    body {
      font-family: sans-serif;
      margin: 20px;
    }
    svg {
      border: 1px solid #ccc;
    }
    .node circle {
      fill: lightblue;
      stroke: steelblue;
      stroke-width: 2px;
    }
    .node text {
      font-size: 14px;
    }
    .eq-box {
      margin-top: 20px;
      padding: 10px;
      background-color: #f4f4f4;
      border-radius: 5px;
    }
  </style>
</head>

<body>
  <h2>Skeletal Path Model</h2>
  <p>Click a node to move the leak.</p>

  <div style="width: 100%; overflow-x: auto; display: flex; justify-content: center;">
    <svg width="100%" height="220" viewBox="0 0 560 220" preserveAspectRatio="xMidYMid meet"></svg>
  </div>

  <div class="eq-box">
    <strong>Input-Output Equation:</strong>
    <div id="equation"></div>
  </div>

  <script>
    const RADIUS = 25;

    const nodes = [
      { id: 0, label: "1" },
      { id: 1, label: "2" },
      { id: 2, label: "3" },
      { id: 3, label: "4" },
    ];

    const nodePositions = [
      { x: 150, y: 80 },   // 1 (left)
      { x: 270, y: 40 },   // 2 (top)
      { x: 390, y: 80 },   // 3 (right)
      { x: 270, y: 120 },  // 4 (bottom)
    ];

    const links = [
      { source: 0, target: 1, label: "a_{21}" },
      { source: 1, target: 2, label: "a_{32}" },
      { source: 2, target: 3, label: "a_{43}" },
      { source: 3, target: 0, label: "a_{14}" },
    ];

    let leakNode = 0;

    const eqLookup = {
      0: "y^{(4)}_4 + (\\textcolor{red}{a_{01}}+a_{21}+a_{32}+a_{43}) y^{(3)}_4 + (\\textcolor{red}{a_{01}}a_{32}+\\textcolor{red}{a_{01}}a_{43}+a_{21}a_{32}+a_{21}a_{43}+a_{32}a_{43}) y''_4 + (\\textcolor{red}{a_{01}}a_{32}a_{43}+a_{21}a_{32}a_{43}) y'_4 = (a_{21}a_{32}a_{43})u_1",
      1: "y^{(4)}_4 + (\\textcolor{red}{a_{02}}+a_{21}+a_{32}+a_{43}) y^{(3)}_4 + (\\textcolor{red}{a_{02}}a_{21}+\\textcolor{red}{a_{02}}a_{43}+a_{21}a_{32}+a_{21}a_{43}+a_{32}a_{43}) y''_4 + (\\textcolor{red}{a_{02}}a_{21}a_{43}+a_{21}a_{32}a_{43}) y'_4 = (a_{21}a_{32}a_{43})u_1",
      2: "y^{(4)}_4 + (\\textcolor{red}{a_{03}}+a_{21}+a_{32}+a_{43}) y^{(3)}_4 + (\\textcolor{red}{a_{03}}a_{21}+\\textcolor{red}{a_{03}}a_{32}+a_{21}a_{32}+a_{21}a_{43}+a_{32}a_{43}) y''_4 + (\\textcolor{red}{a_{03}}a_{21}a_{32}+a_{21}a_{32}a_{43}) y'_4 = (a_{21}a_{32}a_{43})u_1",
      3: "y^{(4)}_4 + (\\textcolor{red}{a_{04}}+a_{21}+a_{32}+a_{43}) y^{(3)}_4 + (\\textcolor{red}{a_{04}}a_{21}+\\textcolor{red}{a_{04}}a_{32}+a_{21}a_{32}+a_{21}a_{43}+a_{32}a_{43}+\\textcolor{red}{a_{04}}a_{43}) y''_4 + (a_{21}a_{32}a_{43}+\\textcolor{red}{a_{04}}a_{32}a_{43}+a_{21}\\textcolor{red}{a_{04}}a_{43}+a_{21}a_{32}\\textcolor{red}{a_{04}}) y'_4 + (\\textcolor{red}{a_{04}}a_{21}a_{32}a_{43})y_4 = (a_{21}a_{32}a_{43})u_1",
    };

    const svg = d3.select("svg");

    // MARKERS
    const defs = svg.append("defs");

    defs.append("marker")
      .attr("id", "lin
